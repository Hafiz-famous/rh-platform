{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block head %}
  <!-- Chart.js -->
   <style>
  :root{
    --radius:16px;
    --shadow:0 2px 8px rgba(16,24,40,.06), 0 1px 2px rgba(16,24,40,.04);
    --shadow-lg:0 12px 24px rgba(16,24,40,.14), 0 6px 10px rgba(16,24,40,.08);
  }

  /* Cartes “soft” + KPIs : micro-animations, 3D tilt via variables CSS */
  .card.card-soft, .kpi-card{
    border: none;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    transition: transform .28s cubic-bezier(.22,.61,.36,1), box-shadow .28s, background .2s;
    transform: translateZ(0) rotateX(var(--rx,0)) rotateY(var(--ry,0)) translateY(var(--tz,0));
    will-change: transform, box-shadow;
    background: #fff;
  }
  .card.card-soft:hover, .kpi-card:hover{
    --tz: -4px;
    box-shadow: var(--shadow-lg);
  }

  /* KPI icon animation au survol */
  .kpi-card .kpi-icon{
    transition: transform .28s;
  }
  .kpi-card:hover .kpi-icon{ transform: scale(1.08) rotate(-2deg); }

  /* EOM trophée avec léger bounce au hover */
  #eom-card .bi-trophy-fill{
    transition: transform .35s cubic-bezier(.2,.8,.2,1);
  }
  #eom-card:hover .bi-trophy-fill{ transform: translateY(-2px) rotate(-6deg) scale(1.06); }

  /* Révélation au scroll */
  [data-reveal]{
    opacity: 0; transform: translateY(10px);
    transition: opacity .5s ease, transform .5s ease;
  }
  [data-reveal].in-view{ opacity: 1; transform: none; }

  /* Effet ripple (clic) sur .btn et .kpi-card */
  .ripple-host{ position: relative; overflow: hidden; }
  .ripple{
    position:absolute; border-radius:50%; pointer-events:none; inset:auto;
    transform: scale(0); opacity:.32; background: currentColor;
    animation: ripple .6s ease-out;
    mix-blend-mode: multiply;
  }
  @keyframes ripple{ to{ transform: scale(12); opacity:0; } }

  /* Accessibilité : désactive les animations si l’utilisateur préfère réduire */
  @media (prefers-reduced-motion: reduce){
    *{ animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; }
  }
</style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="page-title mb-1">Tableau de bord</h1>
    <div class="text-muted small">Mise à jour temps réel • <span id="nowLabel"></span></div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-primary" href="/attendance/scan">
      <i class="bi bi-box-arrow-in-right me-1"></i> Pointer
    </a>
    <a class="btn btn-outline-primary" href="/qr/attendance?action=checkin">
      <i class="bi bi-qr-code-scan me-1"></i> QR Check-in
    </a>
    <a class="btn btn-outline-primary" href="/qr/attendance?action=checkout">
      <i class="bi bi-qr-code me-1"></i> QR Check-out
    </a>
    <a class="btn btn-outline-success" href="/exports/report.pdf">
      <i class="bi bi-filetype-pdf me-1"></i> Rapport PDF
    </a>
  </div>
</div>

{# ——— EMPLOYÉ·E DU MOIS ——— #}
{% set _eom = employee_of_month or {} %}
{% set _name = eom_name or _eom.name %}
{% if _name %}
<div class="card card-soft mb-3 border-success-subtle" id="eom-card">
  <div class="card-body d-flex align-items-center gap-3">
    <div class="rounded-circle bg-warning-subtle text-warning d-flex align-items-center justify-content-center"
         style="width:44px;height:44px;">
      <i class="bi bi-trophy-fill"></i>
    </div>
    <div class="me-auto">
      <div class="text-muted text-uppercase small fw-semibold">Employé·e du mois</div>
      <div class="h5 mb-0" id="eom-name">{{ _name }}</div>
      <div class="text-muted small" id="eom-meta">
        {{ _eom.department|default('—') }} · {{ _eom.period_label|default('') }}
      </div>
    </div>
    <a class="btn btn-sm btn-outline-secondary" href="/users/{{ employee_of_month.user_id }}">Profil</a>
    </a>
  </div>
</div>
{% endif %}

<!-- KPIs -->
<div class="row g-3 mb-3">
  <div class="col-12 col-md-6 col-xl-3">
    <div class="kpi-card">
      <div class="kpi-icon bg-primary-subtle text-primary"><i class="bi bi-people-fill"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Présents (aujourd'hui)</div>
        <div class="kpi-value" id="kpi-present">—</div>
        <div class="kpi-sub" id="kpi-present-sub">Chargement…</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 col-xl-3">
    <div class="kpi-card">
      <div class="kpi-icon bg-info-subtle text-info"><i class="bi bi-clock-history"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Heures totales (aujourd'hui)</div>
        <div class="kpi-value" id="kpi-hours">—</div>
        <div class="kpi-sub" id="kpi-hours-sub">Chargement…</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 col-xl-3">
    <div class="kpi-card">
      <div class="kpi-icon bg-warning-subtle text-warning"><i class="bi bi-sun"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Congés en attente</div>
        <div class="kpi-value" id="kpi-leaves-pending">—</div>
        <div class="kpi-sub"><a href="/leaves/pending" class="link-underline link-underline-opacity-0">Voir la file</a></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6 col-xl-3">
    <div class="kpi-card">
      <div class="kpi-icon bg-danger-subtle text-danger"><i class="bi bi-lightning-charge"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Heures sup en attente</div>
        <div class="kpi-value" id="kpi-ot-pending">—</div>
        <div class="kpi-sub"><a href="/overtime/pending" class="link-underline link-underline-opacity-0">Voir la file</a></div>
      </div>
    </div>
  </div>
</div>

<!-- Graphiques -->
<div class="row g-3">
  <div class="col-12 col-xl-6">
    <div class="card card-soft h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h6 class="mb-0">Présence — 14 jours</h6>
        <span class="text-muted small" id="presenceRangeLabel">Derniers 14 jours</span>
      </div>
      <div class="card-body">
        <canvas id="presenceChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card card-soft h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h6 class="mb-0">Heures sup approuvées — 14 jours</h6>
        <span class="text-muted small">Derniers 14 jours</span>
      </div>
      <div class="card-body">
        <canvas id="overtimeChart" height="120"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card card-soft">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h6 class="mb-0">Coûts RH par département — mois en cours</h6>
        <a class="btn btn-sm btn-outline-secondary" href="/exports/department_costs.csv">
          <i class="bi bi-download"></i> Export CSV
        </a>
      </div>
      <div class="card-body">
        <canvas id="deptChart" height="90"></canvas>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
